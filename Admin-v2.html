<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Punzzle CMS - Content Management System</title>
  <link rel="icon" type="image/png" href="https://punzzle.com/images/favicon.png">
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QLL4GXB1ZX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-QLL4GXB1ZX');
  </script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background-color: #f5f5f5;
      color: #1a1a1a;
      line-height: 1.6;
    }
    
    /* Login Styles */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #326891 0%, #2c5a7a 100%);
    }
    
    .login-card {
      background: white;
      border-radius: 12px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .login-header h1 {
      font-size: 2rem;
      color: #326891;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .login-header p {
      color: #666;
      font-size: 0.9rem;
    }
    
    .login-form .form-group {
      margin-bottom: 20px;
    }
    
    .login-form label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #1a1a1a;
    }
    
    .login-form input {
      width: 100%;
      padding: 12px;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    
    .login-form input:focus {
      outline: none;
      border-color: #326891;
      box-shadow: 0 0 0 2px rgba(50, 104, 145, 0.2);
    }
    
    .login-btn {
      width: 100%;
      padding: 12px;
      background-color: #326891;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .login-btn:hover {
      background-color: #2c5a7a;
    }
    
    .login-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .login-error {
      background: #f8d7da;
      color: #721c24;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-size: 0.9rem;
      text-align: center;
      display: none;
    }
    
    /* Main App Styles */
    .app-container {
      display: none;
    }
    
    .header {
      background: linear-gradient(135deg, #326891 0%, #2c5a7a 100%);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }
    
    .logout-btn {
      position: absolute;
      right: 20px;
      top: 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }
    
    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .status {
      background: rgba(255,255,255,0.2);
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .connection-status {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    
    .status-connected {
      background-color: #28a745;
      box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
    }
    
    .status-disconnected {
      background-color: #dc3545;
      box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .tabs {
      display: flex;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .tab {
      flex: 1;
      padding: 15px 20px;
      background: white;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      color: #666;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }
    
    .tab:hover {
      background-color: #f8fafc;
      color: #326891;
    }
    
    .tab.active {
      color: #326891;
      border-bottom-color: #326891;
      background-color: #f8fafc;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .card {
      background: white;
      border-radius: 8px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .card h2 {
      color: #326891;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #1a1a1a;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
      background-color: #ffffff;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #326891;
      box-shadow: 0 0 0 3px rgba(50, 104, 145, 0.1);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 200px;
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    .category-inputs {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .category-inputs input {
      flex: 1;
    }
    
    .category-plus {
      font-weight: 700;
      color: #326891;
      font-size: 1.5rem;
      padding: 0 10px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn-primary {
      background-color: #326891;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #2c5a7a;
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background-color: #f8fafc;
      color: #666666;
      border: 2px solid #e1e5e9;
    }
    
    .btn-secondary:hover {
      background-color: #e1e5e9;
      color: #1a1a1a;
    }
    
    .btn-danger {
      background-color: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background-color: #c82333;
    }
    
    .btn-success {
      background-color: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background-color: #218838;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .message {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
    }
    
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
    }
    
    .puzzle-list {
      display: grid;
      gap: 15px;
    }
    
    .puzzle-item {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }
    
    .puzzle-item:hover {
      background: #e3f2fd;
      border-color: #326891;
      transform: translateY(-2px);
    }
    
    .puzzle-item.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    
    .puzzle-item.drag-over {
      background: #e3f2fd;
      border-color: #326891;
    }
    
    .drag-handle {
      cursor: grab;
    }
    
    .puzzle-info {
      flex: 1;
      display: flex;
      align-items: center;
    }
    
    .puzzle-details {
      flex: 1;
    }
    
    .puzzle-date {
      font-weight: 700;
      color: #326891;
      font-size: 1.1rem;
      margin-bottom: 8px;
    }
    
    .puzzle-categories {
      font-size: 1rem;
      color: #1a1a1a;
      margin-bottom: 5px;
    }
    
    .puzzle-answer {
      font-size: 0.9rem;
      color: #666;
      font-style: italic;
    }
    
    .puzzle-actions {
      display: flex;
      gap: 10px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 2px solid #e1e5e9;
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: #326891;
      margin-bottom: 8px;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: #666;
      font-weight: 500;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #326891;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .help-text {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 5px;
    }
    
    .preview-box {
      background: #f8fafc;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .preview-title {
      font-weight: 600;
      margin-bottom: 15px;
      color: #326891;
      font-size: 1.1rem;
    }
    
    .preview-content {
      background: white;
      border: 2px solid #e1e5e9;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 10px;
    }
    
    .preview-categories {
      font-size: 0.875rem;
      font-weight: 600;
      color: #326891;
      padding: 8px 12px;
      background-color: rgba(50, 104, 145, 0.1);
      border: 2px solid rgba(50, 104, 145, 0.2);
      border-radius: 6px;
      text-transform: uppercase;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .filter-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-controls input,
    .filter-controls select {
      padding: 8px 12px;
      border: 1px solid #d0d0d0;
      border-radius: 4px;
    }
    
    /* Custom Puzzle Styles */
    .custom-puzzle-item {
      background: #f8f9fa;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      position: relative;
      transition: all 0.2s;
    }
    
    .custom-puzzle-item:hover {
      background: #e3f2fd;
      border-color: #326891;
      transform: translateY(-2px);
    }
    
    .custom-stats {
      display: flex;
      gap: 15px;
      font-size: 0.85rem;
      color: #666;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .delete-custom-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .delete-custom-btn:hover {
      background: #c82333;
    }
    
    .link-row {
      display: flex;
      align-items: center;
      margin-top: 10px;
      gap: 10px;
    }
    
    .link-label {
      font-weight: 600;
      width: 60px;
      font-size: 0.85rem;
    }
    
    .link-input {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid #d0d0d0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85rem;
      background: white;
    }
    
    .copy-btn {
      padding: 6px 12px;
      background: #326891;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    
    .copy-btn:hover {
      background: #2c5a7a;
    }
    
    .download-preview-btn {
      padding: 6px 12px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      margin-left: 5px;
    }
    
    .download-preview-btn:hover {
      background: #218838;
    }
    
    .download-preview-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    /* Bonus Puzzle Styles */
    .bonus-item {
      background: #f0f7ff;
      border: 2px solid #326891;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
    }
    
    .bonus-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    
    .bonus-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #326891;
      margin-bottom: 5px;
    }
    
    .bonus-stats {
      display: flex;
      gap: 20px;
      font-size: 0.85rem;
      color: #666;
      margin: 10px 0;
    }
    
    .bonus-links {
      background: #f8fafc;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .status-active {
      background: #d4edda;
      color: #155724;
    }
    
    .status-expired {
      background: #f8d7da;
      color: #721c24;
    }
    
    /* Analytics Table */
    .analytics-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .analytics-table th,
    .analytics-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }
    
    .analytics-table th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .analytics-table tr:hover {
      background-color: #f8f9fa;
    }
    
    /* Quick date buttons */
    .quick-dates {
      display: flex;
      gap: 5px;
      margin-top: 5px;
    }
    
    .quick-date-btn {
      padding: 5px 10px;
      font-size: 0.85rem;
      background: #e9ecef;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .quick-date-btn:hover {
      background: #dee2e6;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .card {
        padding: 20px;
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .category-inputs {
        flex-direction: column;
      }
      
      .category-plus {
        display: none;
      }
      
      .puzzle-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .puzzle-actions {
        margin-top: 15px;
        width: 100%;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .logout-btn {
        position: static;
        margin-top: 10px;
      }
    }
    
    /* Hidden canvas for preview generation */
    #previewCanvas {
      position: fixed;
      left: -9999px;
      top: -9999px;
      background: #f0f4f8;
      padding: 60px;
      width: 800px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .canvas-categories {
      font-size: 24px;
      font-weight: 600;
      color: #326891;
      background-color: #e1e9f0;
      border-radius: 16px;
      text-transform: uppercase;
      padding: 20px 50px;
      margin-bottom: 50px;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .canvas-puzzle {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    
    .canvas-word {
      display: flex;
      gap: 12px;
    }
    
    .canvas-tile {
      width: 70px;
      height: 70px;
      border: 3px solid #c0c8d0;
      border-radius: 12px;
      background-color: #ffffff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
    }
    
    @media (max-width: 768px) {
      #previewCanvas {
        width: 600px;
        padding: 40px;
      }
    }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div class="login-container" id="loginContainer">
    <div class="login-card">
      <div class="login-header">
        <h1>ü¶ä Punzzle CMS</h1>
        <p>Please sign in to continue</p>
      </div>
      
      <div class="login-error" id="loginError"></div>
      
      <form class="login-form" id="loginForm">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" value="peterjwagoner" required autocomplete="username">
        </div>
        
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" required autocomplete="current-password">
        </div>
        
        <button type="submit" class="login-btn" id="loginBtn">Sign In</button>
      </form>
    </div>
  </div>

  <!-- Main App -->
  <div class="app-container" id="appContainer">
    <div class="header">
      <button class="logout-btn" onclick="logout()">Logout</button>
      <h1>ü¶ä Punzzle CMS</h1>
      <div class="status">
        <span class="connection-status" id="connectionStatus"></span>
        <span id="statusText">Connecting to Firebase...</span>
      </div>
    </div>

    <div class="container">
      <div id="messageContainer"></div>
      
      <div class="tabs">
        <button class="tab active" onclick="showTab('single')">Single Puzzle</button>
        <button class="tab" onclick="showTab('bulk')">Bulk Upload</button>
        <button class="tab" onclick="showTab('manage')">Manage Puzzles</button>
        <button class="tab" onclick="showTab('custom')">Custom Puzzles</button>
        <button class="tab" onclick="showTab('bonus')">Bonus Puzzles</button>
        <button class="tab" onclick="showTab('analytics')">Analytics</button>
        <button class="tab" onclick="showTab('settings')">Settings</button>
      </div>

      <!-- Single Puzzle Tab -->
      <div id="single-tab" class="tab-content active">
        <div class="card">
          <h2>Add Single Puzzle</h2>
          <form id="singlePuzzleForm">
            <div class="form-group">
              <label for="date">Date</label>
              <input type="date" id="date" required>
              <div class="quick-dates">
                <button type="button" class="quick-date-btn" onclick="setQuickDate(0)">Today</button>
                <button type="button" class="quick-date-btn" onclick="setQuickDate(1)">Tomorrow</button>
                <button type="button" class="quick-date-btn" onclick="setQuickDate(7)">Next Week</button>
              </div>
              <div class="help-text">The date this puzzle will be available</div>
            </div>
            
            <div class="form-group">
              <label>Categories</label>
              <div class="category-inputs">
                <input type="text" id="category1" placeholder="First category" maxlength="25" required>
                <span class="category-plus">+</span>
                <input type="text" id="category2" placeholder="Second category" maxlength="25" required>
              </div>
              <div class="help-text">Each category should be 25 characters or less</div>
            </div>

            <div class="form-group">
              <label for="answer">Answer</label>
              <input type="text" id="answer" placeholder="e.g., NEIL PATRICK CARROTS" required>
              <div class="help-text">The full answer (2-5 words, max 12 characters each)</div>
            </div>

            <div class="form-group">
              <label for="hint">Hint (Optional)</label>
              <input type="text" id="hint" placeholder="e.g., A former child star" maxlength="50">
              <div class="help-text">Optional hint for players</div>
            </div>

            <div class="preview-box" id="singlePreview" style="display: none;">
              <div class="preview-title">Preview</div>
              <div id="previewContent"></div>
            </div>

            <div class="btn-group">
              <button type="submit" class="btn btn-primary">Add Puzzle</button>
              <button type="button" class="btn btn-secondary" onclick="previewSingle()">Preview</button>
              <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear</button>
              <button type="button" class="btn btn-secondary" onclick="testConnection()">Test Connection</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Bulk Upload Tab -->
      <div id="bulk-tab" class="tab-content">
        <div class="card">
          <h2>Bulk Upload Puzzles</h2>
          
          <div class="btn-group" style="margin-bottom: 20px;">
            <button class="btn btn-secondary" onclick="showTemplate()">Show Template</button>
            <button class="btn btn-secondary" onclick="downloadTemplate()">Download Template</button>
          </div>
          
          <form id="bulkPuzzleForm">
            <div class="form-group">
              <label for="bulkStartDate">Start Date</label>
              <input type="date" id="bulkStartDate" required>
              <div class="help-text">Puzzles will be assigned consecutive dates starting from this date</div>
            </div>

            <div class="form-group">
              <label for="bulkInput">Bulk Puzzle Data</label>
              <textarea id="bulkInput" placeholder="Format: CATEGORY1 + CATEGORY2 | ANSWER | HINT (optional)

Example:
ACTORS + VEGETABLES | NEIL PATRICK CARROTS | A former child star
MUSICIANS + PASTA | JUSTIN TIMBER LAKE LINGUINE | Bringing spaghetti back
MOVIES + DESSERTS | STAR WARS SUNDAE
TV SHOWS + BEVERAGES | GAME OF SCONES TEA" required></textarea>
              <div class="help-text">One puzzle per line. Lines starting with # are ignored. Hint is optional.</div>
            </div>

            <div class="preview-box" id="bulkPreview" style="display: none;">
              <div class="preview-title">Parsed Puzzles (<span id="bulkCount">0</span> puzzles)</div>
              <div id="bulkPreviewContent"></div>
            </div>

            <div class="btn-group">
              <button type="submit" class="btn btn-primary">Upload All Puzzles</button>
              <button type="button" class="btn btn-secondary" onclick="previewBulk()">Preview</button>
              <button type="button" class="btn btn-secondary" onclick="clearBulk()">Clear</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Manage Puzzles Tab -->
      <div id="manage-tab" class="tab-content">
        <div class="card">
          <h2>Daily Puzzles</h2>
          
          <div class="filter-controls">
            <select id="puzzleOrderBy">
              <option value="date-desc">Date (Newest First)</option>
              <option value="date-asc">Date (Oldest First)</option>
            </select>
            <input type="date" id="filterStartDate" placeholder="Start date">
            <input type="date" id="filterEndDate" placeholder="End date">
            <button class="btn btn-secondary" onclick="filterPuzzles()">Filter</button>
            <button class="btn btn-secondary" onclick="loadPuzzles()">Show All</button>
            <button class="btn btn-success" onclick="exportPuzzles()">Export All</button>
            <button class="btn btn-primary" onclick="savePuzzleOrder()" id="saveOrderBtn" style="display: none;">Save Order</button>
          </div>
          
          <div class="help-text" style="margin: 10px 0;">
            <strong>Tip:</strong> Drag and drop puzzles to reorder them. When you delete a puzzle, subsequent puzzles will automatically shift dates to fill the gap.
            <span id="reorderingMessage" style="display: none; color: #326891; font-weight: 600; margin-left: 10px;">
              ‚ö†Ô∏è You have unsaved changes to the puzzle order. Click "Save Order" to apply changes.
            </span>
          </div>

          <div class="puzzle-list" id="puzzleList">
            <p style="text-align: center; color: #666;">Click "Show All" to load puzzles</p>
          </div>
        </div>
      </div>

      <!-- Custom Puzzles Tab -->
      <div id="custom-tab" class="tab-content">
        <div class="card">
          <h2>Custom Puzzles (User Created)</h2>
          
          <div class="filter-controls">
            <input type="text" id="customSearchInput" placeholder="Search by categories or answer...">
            <select id="customSortBy">
              <option value="created">Sort by Created Date</option>
              <option value="plays">Sort by Play Count</option>
              <option value="views">Sort by Views</option>
              <option value="shares">Sort by Shares</option>
              <option value="completed">Sort by Completion Rate</option>
              <option value="playedAnother">Sort by Play Another Rate</option>
            </select>
            <button class="btn btn-secondary" onclick="loadCustomPuzzles()">Refresh</button>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number" id="totalCustomPuzzles">0</div>
              <div class="stat-label">Total Custom Puzzles</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalCustomViews">0</div>
              <div class="stat-label">Total Views</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalCustomShares">0</div>
              <div class="stat-label">Total Shares</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="avgCustomCompletion">0%</div>
              <div class="stat-label">Avg Completion Rate</div>
            </div>
          </div>

          <div class="puzzle-list" id="customPuzzleList">
            <p style="text-align: center; color: #666;">Click "Refresh" to load custom puzzles</p>
          </div>
        </div>
      </div>

      <!-- Bonus Puzzles Tab -->
      <div id="bonus-tab" class="tab-content">
        <div class="card">
          <h2>Create Bonus Puzzle</h2>
          <p>Create unlisted puzzles for email subscribers with unique, unguessable links.</p>
          
          <form id="bonusPuzzleForm">
            <div class="form-group">
              <label for="bonusTitle">Puzzle Title (for your reference)</label>
              <input type="text" id="bonusTitle" placeholder="e.g., Newsletter Week 12" required>
            </div>
            
            <div class="form-group">
              <label>Categories</label>
              <div class="category-inputs">
                <input type="text" id="bonusCategory1" placeholder="First category" maxlength="25" required>
                <span class="category-plus">+</span>
                <input type="text" id="bonusCategory2" placeholder="Second category" maxlength="25" required>
              </div>
            </div>

            <div class="form-group">
              <label for="bonusAnswer">Answer</label>
              <input type="text" id="bonusAnswer" placeholder="e.g., EXCLUSIVE CONTENT" required>
            </div>

            <div class="form-group">
              <label for="bonusHint">Hint (Optional)</label>
              <input type="text" id="bonusHint" placeholder="e.g., For subscribers only!" maxlength="50">
            </div>

            <div class="form-group">
              <label for="bonusExpiry">Expiry Date (Optional)</label>
              <input type="date" id="bonusExpiry">
              <div class="help-text">Puzzle will be unavailable after this date</div>
            </div>

            <div class="btn-group">
              <button type="submit" class="btn btn-primary">Create Bonus Puzzle</button>
              <button type="button" class="btn btn-secondary" onclick="previewBonus()">Preview</button>
            </div>
          </form>
        </div>

        <div class="card">
          <h2>Active Bonus Puzzles</h2>
          <div class="puzzle-list" id="bonusPuzzleList">
            <p style="text-align: center; color: #666;">No bonus puzzles created yet</p>
          </div>
        </div>
      </div>

      <!-- Analytics Tab -->
      <div id="analytics-tab" class="tab-content">
        <div class="card">
          <h2>Analytics Dashboard</h2>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number" id="totalPuzzles">0</div>
              <div class="stat-label">Total Puzzles</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalPlays">0</div>
              <div class="stat-label">Total Plays</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="completedPuzzles">0</div>
              <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="avgScore">0</div>
              <div class="stat-label">Average Score</div>
            </div>
          </div>

          <h3>Link Click Tracking</h3>
          <table class="analytics-table">
            <thead>
              <tr>
                <th>Link/Button</th>
                <th>Clicks Today</th>
                <th>Clicks This Week</th>
                <th>Total Clicks</th>
              </tr>
            </thead>
            <tbody id="linkTrackingTable">
              <tr><td colspan="4" style="text-align: center; color: #666;">Click "Refresh Analytics" to load data</td></tr>
            </tbody>
          </table>

          <h3 style="margin-top: 30px;">Puzzle Performance</h3>
          <table class="analytics-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Categories</th>
                <th>Plays</th>
                <th>Avg Score</th>
                <th>Completion Rate</th>
              </tr>
            </thead>
            <tbody id="puzzlePerformanceTable">
              <tr><td colspan="5" style="text-align: center; color: #666;">Click "Refresh Analytics" to load data</td></tr>
            </tbody>
          </table>
          
          <div class="btn-group">
            <button class="btn btn-primary" onclick="loadAnalytics()">Refresh Analytics</button>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="settings-tab" class="tab-content">
        <div class="card">
          <h2>Firebase Configuration</h2>
          <p>If you're having issues saving puzzles, check these settings:</p>
          
          <h3>1. Firebase Security Rules</h3>
          <p>Go to Firebase Console > Firestore Database > Rules and ensure you have:</p>
          <textarea readonly style="font-family: monospace; background: #f8f9fa; padding: 1rem; border-radius: 4px; width: 100%; height: 120px;">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}</textarea>
          
          <div class="btn-group">
            <button class="btn btn-primary" onclick="testConnection()">Test Firebase Connection</button>
            <a href="https://console.firebase.google.com" target="_blank" class="btn btn-secondary">Open Firebase Console</a>
          </div>
        </div>
        
        <div class="card">
          <h2>Data Management</h2>
          
          <div class="btn-group">
            <button class="btn btn-success" onclick="exportAllData()">Export All Data</button>
            <button class="btn btn-secondary" onclick="importData()">Import Data</button>
            <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
          </div>
          
          <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
        </div>
      </div>
    </div>
  </div>

  <script>
    // Wait for DOM to be fully loaded
    window.addEventListener('load', function() {
      console.log('Page fully loaded');
      
      // Create hidden canvas container
      var canvasContainer = document.createElement('div');
      canvasContainer.id = 'previewCanvas';
      canvasContainer.innerHTML = `
        <div class="canvas-categories" id="canvasCategories"></div>
        <div class="canvas-puzzle" id="canvasPuzzle"></div>
      `;
      document.body.appendChild(canvasContainer);
      
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDD6fIiRCLLQFUUyUrq-AnipZdomJoVgB8",
        authDomain: "punzzle.firebaseapp.com",
        projectId: "punzzle",
        storageBucket: "punzzle.firebasestorage.app",
        messagingSenderId: "764724354815",
        appId: "1:764724354815:web:339f700ef4165fd45576ca"
      };

      // Global variables
      let db = null;
      let isConnected = false;
      let puzzles = [];
      let customPuzzles = [];
      let bonusPuzzles = [];
      let analytics = {
        totalPlays: 0,
        completedPuzzles: 0,
        incompletePuzzles: 0,
        avgScore: 0,
        shareRate: 0,
        linkClicks: {},
        puzzleStats: {},
        customPuzzleStats: {}
      };

      // Simple authentication
      const VALID_USERNAME = 'peterjwagoner';
      const VALID_PASSWORD = '**molosisi99EUP';
      
      // Track if puzzle order has been modified
      let puzzleOrderModified = false;
      let originalPuzzleOrder = [];
      
      // Set up login form handler
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        console.log('Setting up login form handler');
        loginForm.addEventListener('submit', handleLogin);
      } else {
        console.error('Login form not found!');
      }
      
      function handleLogin(e) {
        e.preventDefault();
        console.log('Login form submitted');
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        console.log('Credentials:', { username, passwordLength: password.length });
        
        if (username === VALID_USERNAME && password === VALID_PASSWORD) {
          console.log('Login successful!');
          document.getElementById('loginContainer').style.display = 'none';
          document.getElementById('appContainer').style.display = 'block';
          initFirebase();
        } else {
          console.log('Login failed - invalid credentials');
          const errorDiv = document.getElementById('loginError');
          errorDiv.textContent = 'Invalid username or password';
          errorDiv.style.display = 'block';
          
          setTimeout(() => {
            errorDiv.style.display = 'none';
          }, 3000);
        }
      }

    // Initialize Firebase
    async function initFirebase() {
      try {
        console.log('üöÄ Initializing Firebase...');
        
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        
        // Test connection
        await db.collection('puzzles').limit(1).get();
        
        isConnected = true;
        updateConnectionStatus(true);
        console.log('‚úÖ Firebase connected successfully');
        
        // Set today's date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
        document.getElementById('bulkStartDate').value = today;
        
        // Load data
        await loadData();
        
      } catch (error) {
        console.error('‚ùå Firebase initialization failed:', error);
        isConnected = false;
        updateConnectionStatus(false, error.message);
      }
    }

    // Update connection status UI
    function updateConnectionStatus(connected, error = '') {
      const statusElement = document.getElementById('connectionStatus');
      const textElement = document.getElementById('statusText');
      
      if (connected) {
        statusElement.className = 'connection-status status-connected';
        textElement.textContent = 'Connected to Firebase';
      } else {
        statusElement.className = 'connection-status status-disconnected';
        textElement.textContent = error ? `Connection failed: ${error}` : 'Disconnected from Firebase';
      }
    }

      // Set initial dates
      const today = new Date().toISOString().split('T')[0];
      const dateInput = document.getElementById('date');
      const bulkStartDateInput = document.getElementById('bulkStartDate');
      if (dateInput) dateInput.value = today;
      if (bulkStartDateInput) bulkStartDateInput.value = today;
      
      // Real-time preview for single puzzle
      ['category1', 'category2', 'answer', 'hint', 'date'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', previewSingle);
        }
      });
    }); // End of window.addEventListener('load')

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('password').value = '';
      }
    }

    // Message system
    function showMessage(text, type = 'success') {
      const container = document.getElementById('messageContainer');
      const message = document.createElement('div');
      message.className = `message ${type}`;
      message.textContent = text;
      
      container.appendChild(message);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        message.remove();
      }, 5000);
      
      // Remove on click
      message.addEventListener('click', () => {
        message.remove();
      });
    }

    // Tab management
    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
      
      // Load data for specific tabs
      if (tabName === 'manage') {
        loadPuzzles();
      } else if (tabName === 'custom') {
        loadCustomPuzzles();
      } else if (tabName === 'analytics') {
        loadAnalytics();
      } else if (tabName === 'bonus') {
        loadBonusPuzzles();
      }
    }

    // Quick date functions
    function setQuickDate(daysFromNow) {
      const date = new Date();
      date.setDate(date.getDate() + daysFromNow);
      const dateStr = date.toISOString().split('T')[0];
      document.getElementById('date').value = dateStr;
      document.getElementById('bulkStartDate').value = dateStr;
    }

    // Single puzzle functions
    function previewSingle() {
      const category1 = document.getElementById('category1').value || 'CATEGORY 1';
      const category2 = document.getElementById('category2').value || 'CATEGORY 2';
      const answer = document.getElementById('answer').value || 'ANSWER';
      const hint = document.getElementById('hint').value;
      const date = document.getElementById('date').value || 'DATE';
      
      const preview = document.getElementById('singlePreview');
      const content = document.getElementById('previewContent');
      
      content.innerHTML = `
        <div class="preview-content">
          <div style="font-weight: 600; margin-bottom: 10px;">Date: ${date}</div>
          <div class="preview-categories">${category1.toUpperCase()} + ${category2.toUpperCase()}</div>
          <div style="margin: 10px 0; font-weight: 600;">Answer: ${answer.toUpperCase()}</div>
          ${hint ? `<div style="color: #666; font-style: italic;">Hint: ${hint}</div>` : '<div style="color: #666; font-style: italic;">No hint</div>'}
        </div>
      `;
      
      preview.style.display = 'block';
    }

    function clearForm() {
      document.getElementById('singlePuzzleForm').reset();
      document.getElementById('singlePreview').style.display = 'none';
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date').value = today;
    }

    // Handle single puzzle submission
    document.getElementById('singlePuzzleForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!isConnected) {
        showMessage('Not connected to Firebase. Please refresh the page.', 'error');
        return;
      }
      
      const category1 = document.getElementById('category1').value.trim().toUpperCase();
      const category2 = document.getElementById('category2').value.trim().toUpperCase();
      const answer = document.getElementById('answer').value.trim().toUpperCase();
      const hint = document.getElementById('hint').value.trim() || null;
      const date = document.getElementById('date').value;
      
      const puzzle = {
        date: date,
        categories: `${category1} + ${category2}`,
        answer: answer,
        hint: hint,
        words: answer.split(' ').filter(w => w),
        created: new Date().toISOString()
      };
      
      try {
        console.log('üíæ Saving puzzle:', puzzle);
        
        await db.collection('puzzles').doc(date).set({
          ...puzzle,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showMessage(`‚úÖ Puzzle saved for ${date}!`, 'success');
        
        // Update local array
        puzzles = puzzles.filter(p => p.date !== date);
        puzzles.push(puzzle);
        
        clearForm();
        
      } catch (error) {
        console.error('‚ùå Save failed:', error);
        
        if (error.code === 'permission-denied') {
          showMessage('‚ùå Permission denied. Check Firebase security rules.', 'error');
        } else {
          showMessage(`‚ùå Save failed: ${error.message}`, 'error');
        }
      }
    });

    // Bulk upload functions
    function showTemplate() {
      const template = `# Bulk Puzzle Template
# Format: CATEGORY1 + CATEGORY2 | ANSWER | HINT (optional)
# One puzzle per line
# Lines starting with # are ignored

ACTORS + VEGETABLES | NEIL PATRICK CARROTS | A former child star
MUSICIANS + PASTA | JUSTIN TIMBER LAKE LINGUINE | Bringing spaghetti back
MOVIES + DESSERTS | STAR WARS SUNDAE
TV SHOWS + BEVERAGES | GAME OF SCONES TEA
SUPERHEROES + FRUITS | WONDER WOMAN GO | A tropical justice warrior`;

      document.getElementById('bulkInput').value = template;
      previewBulk();
    }

    function downloadTemplate() {
      const template = `# Bulk Puzzle Template for Punzzle
# Format: CATEGORY1 + CATEGORY2 | ANSWER | HINT (optional)
# One puzzle per line
# Lines starting with # are ignored

ACTORS + VEGETABLES | NEIL PATRICK CARROTS | A former child star
MUSICIANS + PASTA | JUSTIN TIMBER LAKE LINGUINE | Bringing spaghetti back
MOVIES + DESSERTS | STAR WARS SUNDAE
TV SHOWS + BEVERAGES | GAME OF SCONES TEA
SUPERHEROES + FRUITS | WONDER WOMAN GO | A tropical justice warrior`;

      const blob = new Blob([template], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'punzzle-bulk-template.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    function parseBulkData(data, startDate) {
      const lines = data.split('\n').filter(line => line.trim() && !line.startsWith('#'));
      const puzzles = [];
      
      lines.forEach((line, index) => {
        const parts = line.split('|').map(p => p.trim());
        if (parts.length >= 2) {
          const date = new Date(startDate);
          date.setDate(date.getDate() + index);
          
          const categories = parts[0].toUpperCase();
          const answer = parts[1].toUpperCase();
          const hint = parts[2] || null;
          
          puzzles.push({
            date: date.toISOString().split('T')[0],
            categories: categories,
            answer: answer,
            hint: hint,
            words: answer.split(' ').filter(w => w),
            created: new Date().toISOString()
          });
        }
      });
      
      return puzzles;
    }

    function previewBulk() {
      const startDate = new Date(document.getElementById('bulkStartDate').value);
      const bulkData = document.getElementById('bulkInput').value;
      
      const puzzles = parseBulkData(bulkData, startDate);
      
      const preview = document.getElementById('bulkPreview');
      const content = document.getElementById('bulkPreviewContent');
      document.getElementById('bulkCount').textContent = puzzles.length;
      
      if (puzzles.length === 0) {
        content.innerHTML = '<p style="color: #dc3545;">No valid puzzles found. Check your format.</p>';
      } else {
        content.innerHTML = puzzles.slice(0, 5).map(p => `
          <div class="preview-content">
            <div style="font-weight: 600; margin-bottom: 8px;">Date: ${p.date}</div>
            <div class="preview-categories">${p.categories}</div>
            <div style="margin: 8px 0;">Answer: ${p.answer}</div>
            ${p.hint ? `<div style="color: #666; font-style: italic;">Hint: ${p.hint}</div>` : '<div style="color: #666; font-style: italic;">No hint</div>'}
          </div>
        `).join('') + (puzzles.length > 5 ? `<p style="text-align: center; color: #666; margin-top: 15px;">... and ${puzzles.length - 5} more puzzles</p>` : '');
      }
      
      preview.style.display = 'block';
    }

    function clearBulk() {
      document.getElementById('bulkPuzzleForm').reset();
      document.getElementById('bulkPreview').style.display = 'none';
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('bulkStartDate').value = today;
    }

    // Handle bulk upload
    document.getElementById('bulkPuzzleForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!isConnected) {
        showMessage('Not connected to Firebase. Please refresh the page.', 'error');
        return;
      }
      
      const startDate = new Date(document.getElementById('bulkStartDate').value);
      const bulkData = document.getElementById('bulkInput').value;
      const newPuzzles = parseBulkData(bulkData, startDate);
      
      if (newPuzzles.length === 0) {
        showMessage('No valid puzzles found in bulk data', 'error');
        return;
      }
      
      let savedCount = 0;
      let failedCount = 0;
      
      showMessage(`Uploading ${newPuzzles.length} puzzles...`, 'success');
      
      for (const puzzle of newPuzzles) {
        try {
          await db.collection('puzzles').doc(puzzle.date).set({
            ...puzzle,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          });
          savedCount++;
          console.log(`‚úÖ Saved: ${puzzle.date}`);
          
          // Update local array
          puzzles = puzzles.filter(p => p.date !== puzzle.date);
          puzzles.push(puzzle);
          
        } catch (error) {
          failedCount++;
          console.error(`‚ùå Failed: ${puzzle.date}`, error);
        }
      }
      
      const message = `‚úÖ Upload complete! ${savedCount} saved, ${failedCount} failed`;
      showMessage(message, savedCount > 0 ? 'success' : 'error');
      
      if (savedCount > 0) {
        clearBulk();
      }
    });

    // Load puzzles
    async function loadPuzzles() {
      if (!isConnected) {
        showMessage('Not connected to Firebase', 'error');
        return;
      }
      
      try {
        console.log('üìö Loading puzzles...');
        
        const orderBy = document.getElementById('puzzleOrderBy').value;
        const [field, direction] = orderBy.split('-');
        
        const snapshot = await db.collection('puzzles')
          .orderBy(field, direction)
          .limit(100)
          .get();
        
        puzzles = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data && data.date) {
            puzzles.push(data);
          }
        });
        
        displayPuzzles(puzzles);
        
        // Store original order for comparison
        originalPuzzleOrder = puzzles.map(p => p.date);
        puzzleOrderModified = false;
        console.log(`‚úÖ Loaded ${puzzles.length} puzzles`);
        
      } catch (error) {
        console.error('‚ùå Error loading puzzles:', error);
        showMessage('Error loading puzzles: ' + error.message, 'error');
      }
    }

    function displayPuzzles(puzzleList) {
      const container = document.getElementById('puzzleList');
      
      if (puzzleList.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">No puzzles found.</p>';
        return;
      }
      
      container.innerHTML = puzzleList.map(p => `
        <div class="puzzle-item" draggable="true" data-date="${p.date}">
          <div class="puzzle-info">
            <span class="drag-handle" style="margin-right: 10px; font-size: 1.2rem;">‚ò∞</span>
            <div class="puzzle-details">
              <div class="puzzle-date">${p.date}</div>
              <div class="puzzle-categories">${p.categories}</div>
              <div class="puzzle-answer">Answer: ${p.answer}</div>
              ${p.hint ? `<div class="help-text">Hint: ${p.hint}</div>` : '<div class="help-text">No hint</div>'}
            </div>
          </div>
          <div class="puzzle-actions">
            <button class="btn btn-secondary" onclick="editPuzzle('${p.date}')">Edit</button>
            <button class="btn btn-danger" onclick="deletePuzzle('${p.date}')">Delete</button>
          </div>
        </div>
      `).join('');
      
      // Add drag and drop event listeners
      setupDragAndDrop();
    }
    
    // Setup drag and drop functionality
    function setupDragAndDrop() {
      const puzzleItems = document.querySelectorAll('.puzzle-item');
      let draggedElement = null;
      
      puzzleItems.forEach(item => {
        item.addEventListener('dragstart', function(e) {
          draggedElement = this;
          this.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', this.innerHTML);
        });
        
        item.addEventListener('dragend', function(e) {
          this.classList.remove('dragging');
        });
        
        item.addEventListener('dragover', function(e) {
          if (e.preventDefault) {
            e.preventDefault();
          }
          e.dataTransfer.dropEffect = 'move';
          this.classList.add('drag-over');
          return false;
        });
        
        item.addEventListener('dragleave', function(e) {
          this.classList.remove('drag-over');
          
          if (draggedElement !== this) {
            // Get the container
            const container = document.getElementById('puzzleList');
            
            // Get all puzzle items
            const allItems = Array.from(container.querySelectorAll('.puzzle-item'));
            
            // Find indices
            const draggedIndex = allItems.indexOf(draggedElement);
            const targetIndex = allItems.indexOf(this);
            
            // Reorder in DOM
            if (draggedIndex < targetIndex) {
              this.parentNode.insertBefore(draggedElement, this.nextSibling);
            } else {
              this.parentNode.insertBefore(draggedElement, this);
            }
            
            // Update puzzles array to match new order
            updatePuzzleOrder();
          }
          
          return false;
        });
      });
    }
    
    // Update puzzle order after drag and drop
    function updatePuzzleOrder() {
      const puzzleItems = document.querySelectorAll('.puzzle-item');
      const newOrder = Array.from(puzzleItems).map(item => item.dataset.date);
      
      // Check if order has changed
      puzzleOrderModified = !arraysEqual(newOrder, originalPuzzleOrder);
      
      // Show/hide save button and message
      document.getElementById('saveOrderBtn').style.display = puzzleOrderModified ? 'inline-block' : 'none';
      document.getElementById('reorderingMessage').style.display = puzzleOrderModified ? 'inline' : 'none';
    }
    
    function arraysEqual(a, b) {
      return a.length === b.length && a.every((val, index) => val === b[index]);
    }
        });
        
        item.addEventListener('drop', function(e) {
          if (e.stopPropagation) {
            e.stopPropagation();
          }
          
          this.classList.remove('drag-over');