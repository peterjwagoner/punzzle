<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Punzzle CMS - Content Management System</title>
  <link rel="icon" type="image/png" href="https://punzzle.com/images/favicon.png">
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QLL4GXB1ZX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-QLL4GXB1ZX');
  </script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background-color: #f5f5f5;
      color: #1a1a1a;
      line-height: 1.6;
    }
    
    /* Login Styles */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #326891 0%, #2c5a7a 100%);
    }
    
    .login-card {
      background: white;
      border-radius: 12px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .login-header h1 {
      font-size: 2rem;
      color: #326891;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .login-header p {
      color: #666;
      font-size: 0.9rem;
    }
    
    .login-form .form-group {
      margin-bottom: 20px;
    }
    
    .login-form label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #1a1a1a;
    }
    
    .login-form input {
      width: 100%;
      padding: 12px;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    
    .login-form input:focus {
      outline: none;
      border-color: #326891;
      box-shadow: 0 0 0 2px rgba(50, 104, 145, 0.2);
    }
    
    .login-btn {
      width: 100%;
      padding: 12px;
      background-color: #326891;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .login-btn:hover {
      background-color: #2c5a7a;
    }
    
    .login-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .login-error {
      background: #f8d7da;
      color: #721c24;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-size: 0.9rem;
      text-align: center;
      display: none;
    }
    
    /* Main App Styles */
    .app-container {
      display: none;
    }
    
    .header {
      background: linear-gradient(135deg, #326891 0%, #2c5a7a 100%);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }
    
    .logout-btn {
      position: absolute;
      right: 20px;
      top: 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }
    
    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .status {
      background: rgba(255,255,255,0.2);
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .connection-status {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    
    .status-connected {
      background-color: #28a745;
      box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
    }
    
    .status-disconnected {
      background-color: #dc3545;
      box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .tabs {
      display: flex;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .tab {
      flex: 1;
      padding: 15px 20px;
      background: white;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      color: #666;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }
    
    .tab:hover {
      background-color: #f8fafc;
      color: #326891;
    }
    
    .tab.active {
      color: #326891;
      border-bottom-color: #326891;
      background-color: #f8fafc;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .card {
      background: white;
      border-radius: 8px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .card h2 {
      color: #326891;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #1a1a1a;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
      background-color: #ffffff;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #326891;
      box-shadow: 0 0 0 3px rgba(50, 104, 145, 0.1);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 200px;
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    .category-inputs {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .category-inputs input {
      flex: 1;
    }
    
    .category-plus {
      font-weight: 700;
      color: #326891;
      font-size: 1.5rem;
      padding: 0 10px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn-primary {
      background-color: #326891;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #2c5a7a;
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background-color: #f8fafc;
      color: #666666;
      border: 2px solid #e1e5e9;
    }
    
    .btn-secondary:hover {
      background-color: #e1e5e9;
      color: #1a1a1a;
    }
    
    .btn-danger {
      background-color: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background-color: #c82333;
    }
    
    .btn-success {
      background-color: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background-color: #218838;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .message {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
    }
    
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
    }
    
    .puzzle-list {
      display: grid;
      gap: 15px;
    }
    
    .puzzle-item {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }
    
    .puzzle-item:hover {
      background: #e3f2fd;
      border-color: #326891;
      transform: translateY(-2px);
    }
    
    .puzzle-info {
      flex: 1;
    }
    
    .puzzle-date {
      font-weight: 700;
      color: #326891;
      font-size: 1.1rem;
      margin-bottom: 8px;
    }
    
    .puzzle-categories {
      font-size: 1rem;
      color: #1a1a1a;
      margin-bottom: 5px;
    }
    
    .puzzle-answer {
      font-size: 0.9rem;
      color: #666;
      font-style: italic;
    }
    
    .puzzle-actions {
      display: flex;
      gap: 10px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 2px solid #e1e5e9;
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: #326891;
      margin-bottom: 8px;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: #666;
      font-weight: 500;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #326891;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .help-text {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 5px;
    }
    
    .preview-box {
      background: #f8fafc;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .preview-title {
      font-weight: 600;
      margin-bottom: 15px;
      color: #326891;
      font-size: 1.1rem;
    }
    
    .preview-content {
      background: white;
      border: 2px solid #e1e5e9;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 10px;
    }
    
    .preview-categories {
      font-size: 0.875rem;
      font-weight: 600;
      color: #326891;
      padding: 8px 12px;
      background-color: rgba(50, 104, 145, 0.1);
      border: 2px solid rgba(50, 104, 145, 0.2);
      border-radius: 6px;
      text-transform: uppercase;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .filter-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-controls input,
    .filter-controls select {
      padding: 8px 12px;
      border: 1px solid #d0d0d0;
      border-radius: 4px;
    }
    
    /* Custom Puzzle Styles */
    .custom-puzzle-item {
      background: #f8f9fa;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      position: relative;
      transition: all 0.2s;
    }
    
    .custom-puzzle-item:hover {
      background: #e3f2fd;
      border-color: #326891;
      transform: translateY(-2px);
    }
    
    .custom-stats {
      display: flex;
      gap: 15px;
      font-size: 0.85rem;
      color: #666;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .delete-custom-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .delete-custom-btn:hover {
      background: #c82333;
    }
    
    .link-row {
      display: flex;
      align-items: center;
      margin-top: 10px;
      gap: 10px;
    }
    
    .link-label {
      font-weight: 600;
      width: 60px;
      font-size: 0.85rem;
    }
    
    .link-input {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid #d0d0d0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85rem;
      background: white;
    }
    
    .copy-btn {
      padding: 6px 12px;
      background: #326891;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    
    .copy-btn:hover {
      background: #2c5a7a;
    }
    
    /* Bonus Puzzle Styles */
    .bonus-item {
      background: #f0f7ff;
      border: 2px solid #326891;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
    }
    
    .bonus-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    
    .bonus-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #326891;
      margin-bottom: 5px;
    }
    
    .bonus-stats {
      display: flex;
      gap: 20px;
      font-size: 0.85rem;
      color: #666;
      margin: 10px 0;
    }
    
    .bonus-links {
      background: #f8fafc;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .status-active {
      background: #d4edda;
      color: #155724;
    }
    
    .status-expired {
      background: #f8d7da;
      color: #721c24;
    }
    
    /* Analytics Table */
    .analytics-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .analytics-table th,
    .analytics-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }
    
    .analytics-table th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .analytics-table tr:hover {
      background-color: #f8f9fa;
    }
    
    /* Quick date buttons */
    .quick-dates {
      display: flex;
      gap: 5px;
      margin-top: 5px;
    }
    
    .quick-date-btn {
      padding: 5px 10px;
      font-size: 0.85rem;
      background: #e9ecef;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .quick-date-btn:hover {
      background: #dee2e6;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .card {
        padding: 20px;
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .category-inputs {
        flex-direction: column;
      }
      
      .category-plus {
        display: none;
      }
      
      .puzzle-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .puzzle-actions {
        margin-top: 15px;
        width: 100%;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .logout-btn {
        position: static;
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-container" id="loginContainer">
    <div class="login-card">
      <div class="login-header">
        <h1>🦊 Punzzle CMS</h1>
        <p>Please sign in to continue</p>
      </div>
      
      <div class="login-error" id="loginError"></div>
      
      <form class="login-form" id="loginForm">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" value="peterjwagoner" required autocomplete="username">
        </div>
        
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" required autocomplete="current-password">
        </div>
        
        <button type="submit" class="login-btn" id="loginBtn">Sign In</button>
      </form>
    </div>
  </div>

  <!-- Main App -->
  <div class="app-container" id="appContainer">
    <div class="header">
      <button class="logout-btn" onclick="logout()">Logout</button>
      <h1>🦊 Punzzle CMS</h1>
      <div class="status">
        <span class="connection-status" id="connectionStatus"></span>
        <span id="statusText">Connecting to Firebase...</span>
      </div>
    </div>

    <div class="container">
      <div id="messageContainer"></div>
      
      <div class="tabs">
        <button class="tab active" onclick="showTab('single')">Single Puzzle</button>
        <button class="tab" onclick="showTab('bulk')">Bulk Upload</button>
        <button class="tab" onclick="showTab('manage')">Manage Puzzles</button>
        <button class="tab" onclick="showTab('custom')">Custom Puzzles</button>
        <button class="tab" onclick="showTab('bonus')">Bonus Puzzles</button>
        <button class="tab" onclick="showTab('analytics')">Analytics</button>
        <button class="tab" onclick="showTab('settings')">Settings</button>
      </div>

      <!-- Single Puzzle Tab -->
      <div id="single-tab" class="tab-content active">
        <div class="card">
          <h2>Add Single Puzzle</h2>
          <form id="singlePuzzleForm">
            <div class="form-group">
              <label for="date">Date</label>
              <input type="date" id="date" required>
              <div class="quick-dates">
                <button type="button" class="quick-date-btn" onclick="setQuickDate(0)">Today</button>
                <button type="button" class="quick-date-btn" onclick="setQuickDate(1)">Tomorrow</button>
                <button type="button" class="quick-date-btn" onclick="setQuickDate(7)">Next Week</button>
              </div>
              <div class="help-text">The date this puzzle will be available</div>
            </div>
            
            <div class="form-group">
              <label>Categories</label>
              <div class="category-inputs">
                <input type="text" id="category1" placeholder="First category" maxlength="25" required>
                <span class="category-plus">+</span>
                <input type="text" id="category2" placeholder="Second category" maxlength="25" required>
              </div>
              <div class="help-text">Each category should be 25 characters or less</div>
            </div>

            <div class="form-group">
              <label for="answer">Answer</label>
              <input type="text" id="answer" placeholder="e.g., NEIL PATRICK CARROTS" required>
              <div class="help-text">The full answer (2-5 words, max 12 characters each)</div>
            </div>

            <div class="form-group">
              <label for="hint">Hint (Optional)</label>
              <input type="text" id="hint" placeholder="e.g., A former child star" maxlength="50">
              <div class="help-text">Optional hint for players</div>
            </div>

            <div class="preview-box" id="singlePreview" style="display: none;">
              <div class="preview-title">Preview</div>
              <div id="previewContent"></div>
            </div>

            <div class="btn-group">
              <button type="submit" class="btn btn-primary">Add Puzzle</button>
              <button type="button" class="btn btn-secondary" onclick="previewSingle()">Preview</button>
              <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear</button>
              <button type="button" class="btn btn-secondary" onclick="testConnection()">Test Connection</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Bulk Upload Tab -->
      <div id="bulk-tab" class="tab-content">
        <div class="card">
          <h2>Bulk Upload Puzzles</h2>
          
          <div class="btn-group" style="margin-bottom: 20px;">
            <button class="btn btn-secondary" onclick="showTemplate()">Show Template</button>
            <button class="btn btn-secondary" onclick="downloadTemplate()">Download Template</button>
          </div>
          
          <form id="bulkPuzzleForm">
            <div class="form-group">
              <label for="bulkStartDate">Start Date</label>
              <input type="date" id="bulkStartDate" required>
              <div class="help-text">Puzzles will be assigned consecutive dates starting from this date</div>
            </div>

            <div class="form-group">
              <label for="bulkInput">Bulk Puzzle Data</label>
              <textarea id="bulkInput" placeholder="Format: CATEGORY1 + CATEGORY2 | ANSWER | HINT (optional)

Example:
ACTORS + VEGETABLES | NEIL PATRICK CARROTS | A former child star
MUSICIANS + PASTA | JUSTIN TIMBER LAKE LINGUINE | Bringing spaghetti back
MOVIES + DESSERTS | STAR WARS SUNDAE
TV SHOWS + BEVERAGES | GAME OF SCONES TEA" required></textarea>
              <div class="help-text">One puzzle per line. Lines starting with # are ignored. Hint is optional.</div>
            </div>

            <div class="preview-box" id="bulkPreview" style="display: none;">
              <div class="preview-title">Parsed Puzzles (<span id="bulkCount">0</span> puzzles)</div>
              <div id="bulkPreviewContent"></div>
            </div>

            <div class="btn-group">
              <button type="submit" class="btn btn-primary">Upload All Puzzles</button>
              <button type="button" class="btn btn-secondary" onclick="previewBulk()">Preview</button>
              <button type="button" class="btn btn-secondary" onclick="clearBulk()">Clear</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Manage Puzzles Tab -->
      <div id="manage-tab" class="tab-content">
        <div class="card">
          <h2>Daily Puzzles</h2>
          
          <div class="filter-controls">
            <input type="date" id="filterStartDate" placeholder="Start date">
            <input type="date" id="filterEndDate" placeholder="End date">
            <button class="btn btn-secondary" onclick="filterPuzzles()">Filter</button>
            <button class="btn btn-secondary" onclick="loadPuzzles()">Show All</button>
            <button class="btn btn-success" onclick="exportPuzzles()">Export All</button>
          </div>

          <div class="puzzle-list" id="puzzleList">
            <p style="text-align: center; color: #666;">Click "Show All" to load puzzles</p>
          </div>
        </div>
      </div>

      <!-- Custom Puzzles Tab -->
      <div id="custom-tab" class="tab-content">
        <div class="card">
          <h2>Custom Puzzles (User Created)</h2>
          
          <div class="filter-controls">
            <input type="text" id="customSearchInput" placeholder="Search by categories or answer...">
            <select id="customSortBy">
              <option value="created">Sort by Created Date</option>
              <option value="plays">Sort by Play Count</option>
              <option value="views">Sort by Views</option>
              <option value="shares">Sort by Shares</option>
              <option value="completed">Sort by Completion Rate</option>
              <option value="playedAnother">Sort by Play Another Rate</option>
            </select>
            <button class="btn btn-secondary" onclick="loadCustomPuzzles()">Refresh</button>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number" id="totalCustomPuzzles">0</div>
              <div class="stat-label">Total Custom Puzzles</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalCustomViews">0</div>
              <div class="stat-label">Total Views</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalCustomShares">0</div>
              <div class="stat-label">Total Shares</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="avgCustomCompletion">0%</div>
              <div class="stat-label">Avg Completion Rate</div>
            </div>
          </div>

          <div class="puzzle-list" id="customPuzzleList">
            <p style="text-align: center; color: #666;">Click "Refresh" to load custom puzzles</p>
          </div>
        </div>
      </div>

      <!-- Bonus Puzzles Tab -->
      <div id="bonus-tab" class="tab-content">
        <div class="card">
          <h2>Create Bonus Puzzle</h2>
          <p>Create unlisted puzzles for email subscribers with unique, unguessable links.</p>
          
          <form id="bonusPuzzleForm">
            <div class="form-group">
              <label for="bonusTitle">Puzzle Title (for your reference)</label>
              <input type="text" id="bonusTitle" placeholder="e.g., Newsletter Week 12" required>
            </div>
            
            <div class="form-group">
              <label>Categories</label>
              <div class="category-inputs">
                <input type="text" id="bonusCategory1" placeholder="First category" maxlength="25" required>
                <span class="category-plus">+</span>
                <input type="text" id="bonusCategory2" placeholder="Second category" maxlength="25" required>
              </div>
            </div>

            <div class="form-group">
              <label for="bonusAnswer">Answer</label>
              <input type="text" id="bonusAnswer" placeholder="e.g., EXCLUSIVE CONTENT" required>
            </div>

            <div class="form-group">
              <label for="bonusHint">Hint (Optional)</label>
              <input type="text" id="bonusHint" placeholder="e.g., For subscribers only!" maxlength="50">
            </div>

            <div class="form-group">
              <label for="bonusExpiry">Expiry Date (Optional)</label>
              <input type="date" id="bonusExpiry">
              <div class="help-text">Puzzle will be unavailable after this date</div>
            </div>

            <div class="btn-group">
              <button type="submit" class="btn btn-primary">Create Bonus Puzzle</button>
              <button type="button" class="btn btn-secondary" onclick="previewBonus()">Preview</button>
            </div>
          </form>
        </div>

        <div class="card">
          <h2>Active Bonus Puzzles</h2>
          <div class="puzzle-list" id="bonusPuzzleList">
            <p style="text-align: center; color: #666;">No bonus puzzles created yet</p>
          </div>
        </div>
      </div>

      <!-- Analytics Tab -->
      <div id="analytics-tab" class="tab-content">
        <div class="card">
          <h2>Analytics Dashboard</h2>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number" id="totalPuzzles">0</div>
              <div class="stat-label">Total Puzzles</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalPlays">0</div>
              <div class="stat-label">Total Plays</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="completedPuzzles">0</div>
              <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="avgScore">0</div>
              <div class="stat-label">Average Score</div>
            </div>
          </div>

          <h3>Link Click Tracking</h3>
          <table class="analytics-table">
            <thead>
              <tr>
                <th>Link/Button</th>
                <th>Clicks Today</th>
                <th>Clicks This Week</th>
                <th>Total Clicks</th>
              </tr>
            </thead>
            <tbody id="linkTrackingTable">
              <tr><td colspan="4" style="text-align: center; color: #666;">Click "Refresh Analytics" to load data</td></tr>
            </tbody>
          </table>

          <h3 style="margin-top: 30px;">Puzzle Performance</h3>
          <table class="analytics-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Categories</th>
                <th>Plays</th>
                <th>Avg Score</th>
                <th>Completion Rate</th>
              </tr>
            </thead>
            <tbody id="puzzlePerformanceTable">
              <tr><td colspan="5" style="text-align: center; color: #666;">Click "Refresh Analytics" to load data</td></tr>
            </tbody>
          </table>
          
          <div class="btn-group">
            <button class="btn btn-primary" onclick="loadAnalytics()">Refresh Analytics</button>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="settings-tab" class="tab-content">
        <div class="card">
          <h2>Firebase Configuration</h2>
          <p>If you're having issues saving puzzles, check these settings:</p>
          
          <h3>1. Firebase Security Rules</h3>
          <p>Go to Firebase Console > Firestore Database > Rules and ensure you have:</p>
          <textarea readonly style="font-family: monospace; background: #f8f9fa; padding: 1rem; border-radius: 4px; width: 100%; height: 120px;">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}</textarea>
          
          <div class="btn-group">
            <button class="btn btn-primary" onclick="testConnection()">Test Firebase Connection</button>
            <a href="https://console.firebase.google.com" target="_blank" class="btn btn-secondary">Open Firebase Console</a>
          </div>
        </div>
        
        <div class="card">
          <h2>Data Management</h2>
          
          <div class="btn-group">
            <button class="btn btn-success" onclick="exportAllData()">Export All Data</button>
            <button class="btn btn-secondary" onclick="importData()">Import Data</button>
            <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
          </div>
          
          <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDD6fIiRCLLQFUUyUrq-AnipZdomJoVgB8",
      authDomain: "punzzle.firebaseapp.com",
      projectId: "punzzle",
      storageBucket: "punzzle.firebasestorage.app",
      messagingSenderId: "764724354815",
      appId: "1:764724354815:web:339f700ef4165fd45576ca"
    };

    // Global variables
    let db = null;
    let isConnected = false;
    let puzzles = [];
    let customPuzzles = [];
    let bonusPuzzles = [];
    let analytics = {
      totalPlays: 0,
      completedPuzzles: 0,
      incompletePuzzles: 0,
      avgScore: 0,
      shareRate: 0,
      linkClicks: {},
      puzzleStats: {},
      customPuzzleStats: {}
    };

    // Simple authentication
    const VALID_USERNAME = 'peterjwagoner';
    const VALID_PASSWORD = '**molosisi99EUP';

    // Initialize Firebase
    async function initFirebase() {
      try {
        console.log('🚀 Initializing Firebase...');
        
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        
        // Test connection
        await db.collection('puzzles').limit(1).get();
        
        isConnected = true;
        updateConnectionStatus(true);
        console.log('✅ Firebase connected successfully');
        
        // Set today's date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
        document.getElementById('bulkStartDate').value = today;
        
        // Load data
        await loadData();
        
      } catch (error) {
        console.error('❌ Firebase initialization failed:', error);
        isConnected = false;
        updateConnectionStatus(false, error.message);
      }
    }

    // Update connection status UI
    function updateConnectionStatus(connected, error = '') {
      const statusElement = document.getElementById('connectionStatus');
      const textElement = document.getElementById('statusText');
      
      if (connected) {
        statusElement.className = 'connection-status status-connected';
        textElement.textContent = 'Connected to Firebase';
      } else {
        statusElement.className = 'connection-status status-disconnected';
        textElement.textContent = error ? `Connection failed: ${error}` : 'Disconnected from Firebase';
      }
    }

    // Authentication
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      if (username === VALID_USERNAME && password === VALID_PASSWORD) {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';
        initFirebase();
      } else {
        const errorDiv = document.getElementById('loginError');
        errorDiv.textContent = 'Invalid username or password';
        errorDiv.style.display = 'block';
        
        setTimeout(() => {
          errorDiv.style.display = 'none';
        }, 3000);
      }
    });

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('password').value = '';
      }
    }

    // Message system
    function showMessage(text, type = 'success') {
      const container = document.getElementById('messageContainer');
      const message = document.createElement('div');
      message.className = `message ${type}`;
      message.textContent = text;
      
      container.appendChild(message);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        message.remove();
      }, 5000);
      
      // Remove on click
      message.addEventListener('click', () => {
        message.remove();
      });
    }

    // Tab management
    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
      
      // Load data for specific tabs
      if (tabName === 'manage') {
        loadPuzzles();
      } else if (tabName === 'custom') {
        loadCustomPuzzles();
      } else if (tabName === 'analytics') {
        loadAnalytics();
      } else if (tabName === 'bonus') {
        loadBonusPuzzles();
      }
    }

    // Quick date functions
    function setQuickDate(daysFromNow) {
      const date = new Date();
      date.setDate(date.getDate() + daysFromNow);
      const dateStr = date.toISOString().split('T')[0];
      document.getElementById('date').value = dateStr;
      document.getElementById('bulkStartDate').value = dateStr;
    }

    // Single puzzle functions
    function previewSingle() {
      const category1 = document.getElementById('category1').value || 'CATEGORY 1';
      const category2 = document.getElementById('category2').value || 'CATEGORY 2';
      const answer = document.getElementById('answer').value || 'ANSWER';
      const hint = document.getElementById('hint').value;
      const date = document.getElementById('date').value || 'DATE';
      
      const preview = document.getElementById('singlePreview');
      const content = document.getElementById('previewContent');
      
      content.innerHTML = `
        <div class="preview-content">
          <div style="font-weight: 600; margin-bottom: 10px;">Date: ${date}</div>
          <div class="preview-categories">${category1.toUpperCase()} + ${category2.toUpperCase()}</div>
          <div style="margin: 10px 0; font-weight: 600;">Answer: ${answer.toUpperCase()}</div>
          ${hint ? `<div style="color: #666; font-style: italic;">Hint: ${hint}</div>` : '<div style="color: #666; font-style: italic;">No hint</div>'}
        </div>
      `;
      
      preview.style.display = 'block';
    }

    function clearForm() {
      document.getElementById('singlePuzzleForm').reset();
      document.getElementById('singlePreview').style.display = 'none';
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date').value = today;
    }

    // Handle single puzzle submission
    document.getElementById('singlePuzzleForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!isConnected) {
        showMessage('Not connected to Firebase. Please refresh the page.', 'error');
        return;
      }
      
      const category1 = document.getElementById('category1').value.trim().toUpperCase();
      const category2 = document.getElementById('category2').value.trim().toUpperCase();
      const answer = document.getElementById('answer').value.trim().toUpperCase();
      const hint = document.getElementById('hint').value.trim() || null;
      const date = document.getElementById('date').value;
      
      const puzzle = {
        date: date,
        categories: `${category1} + ${category2}`,
        answer: answer,
        hint: hint,
        words: answer.split(' ').filter(w => w),
        created: new Date().toISOString()
      };
      
      try {
        console.log('💾 Saving puzzle:', puzzle);
        
        await db.collection('puzzles').doc(date).set({
          ...puzzle,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showMessage(`✅ Puzzle saved for ${date}!`, 'success');
        
        // Update local array
        puzzles = puzzles.filter(p => p.date !== date);
        puzzles.push(puzzle);
        
        clearForm();
        
      } catch (error) {
        console.error('❌ Save failed:', error);
        
        if (error.code === 'permission-denied') {
          showMessage('❌ Permission denied. Check Firebase security rules.', 'error');
        } else {
          showMessage(`❌ Save failed: ${error.message}`, 'error');
        }
      }
    });

    // Bulk upload functions
    function showTemplate() {
      const template = `# Bulk Puzzle Template
# Format: CATEGORY1 + CATEGORY2 | ANSWER | HINT (optional)
# One puzzle per line
# Lines starting with # are ignored

ACTORS + VEGETABLES | NEIL PATRICK CARROTS | A former child star
MUSICIANS + PASTA | JUSTIN TIMBER LAKE LINGUINE | Bringing spaghetti back
MOVIES + DESSERTS | STAR WARS SUNDAE
TV SHOWS + BEVERAGES | GAME OF SCONES TEA
SUPERHEROES + FRUITS | WONDER WOMAN GO | A tropical justice warrior`;

      document.getElementById('bulkInput').value = template;
      previewBulk();
    }

    function downloadTemplate() {
      const template = `# Bulk Puzzle Template for Punzzle
# Format: CATEGORY1 + CATEGORY2 | ANSWER | HINT (optional)
# One puzzle per line
# Lines starting with # are ignored

ACTORS + VEGETABLES | NEIL PATRICK CARROTS | A former child star
MUSICIANS + PASTA | JUSTIN TIMBER LAKE LINGUINE | Bringing spaghetti back
MOVIES + DESSERTS | STAR WARS SUNDAE
TV SHOWS + BEVERAGES | GAME OF SCONES TEA
SUPERHEROES + FRUITS | WONDER WOMAN GO | A tropical justice warrior`;

      const blob = new Blob([template], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'punzzle-bulk-template.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    function parseBulkData(data, startDate) {
      const lines = data.split('\n').filter(line => line.trim() && !line.startsWith('#'));
      const puzzles = [];
      
      lines.forEach((line, index) => {
        const parts = line.split('|').map(p => p.trim());
        if (parts.length >= 2) {
          const date = new Date(startDate);
          date.setDate(date.getDate() + index);
          
          const categories = parts[0].toUpperCase();
          const answer = parts[1].toUpperCase();
          const hint = parts[2] || null;
          
          puzzles.push({
            date: date.toISOString().split('T')[0],
            categories: categories,
            answer: answer,
            hint: hint,
            words: answer.split(' ').filter(w => w),
            created: new Date().toISOString()
          });
        }
      });
      
      return puzzles;
    }

    function previewBulk() {
      const startDate = new Date(document.getElementById('bulkStartDate').value);
      const bulkData = document.getElementById('bulkInput').value;
      
      const puzzles = parseBulkData(bulkData, startDate);
      
      const preview = document.getElementById('bulkPreview');
      const content = document.getElementById('bulkPreviewContent');
      document.getElementById('bulkCount').textContent = puzzles.length;
      
      if (puzzles.length === 0) {
        content.innerHTML = '<p style="color: #dc3545;">No valid puzzles found. Check your format.</p>';
      } else {
        content.innerHTML = puzzles.slice(0, 5).map(p => `
          <div class="preview-content">
            <div style="font-weight: 600; margin-bottom: 8px;">Date: ${p.date}</div>
            <div class="preview-categories">${p.categories}</div>
            <div style="margin: 8px 0;">Answer: ${p.answer}</div>
            ${p.hint ? `<div style="color: #666; font-style: italic;">Hint: ${p.hint}</div>` : '<div style="color: #666; font-style: italic;">No hint</div>'}
          </div>
        `).join('') + (puzzles.length > 5 ? `<p style="text-align: center; color: #666; margin-top: 15px;">... and ${puzzles.length - 5} more puzzles</p>` : '');
      }
      
      preview.style.display = 'block';
    }

    function clearBulk() {
      document.getElementById('bulkPuzzleForm').reset();
      document.getElementById('bulkPreview').style.display = 'none';
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('bulkStartDate').value = today;
    }

    // Handle bulk upload
    document.getElementById('bulkPuzzleForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!isConnected) {
        showMessage('Not connected to Firebase. Please refresh the page.', 'error');
        return;
      }
      
      const startDate = new Date(document.getElementById('bulkStartDate').value);
      const bulkData = document.getElementById('bulkInput').value;
      const newPuzzles = parseBulkData(bulkData, startDate);
      
      if (newPuzzles.length === 0) {
        showMessage('No valid puzzles found in bulk data', 'error');
        return;
      }
      
      let savedCount = 0;
      let failedCount = 0;
      
      showMessage(`Uploading ${newPuzzles.length} puzzles...`, 'success');
      
      for (const puzzle of newPuzzles) {
        try {
          await db.collection('puzzles').doc(puzzle.date).set({
            ...puzzle,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          });
          savedCount++;
          console.log(`✅ Saved: ${puzzle.date}`);
          
          // Update local array
          puzzles = puzzles.filter(p => p.date !== puzzle.date);
          puzzles.push(puzzle);
          
        } catch (error) {
          failedCount++;
          console.error(`❌ Failed: ${puzzle.date}`, error);
        }
      }
      
      const message = `✅ Upload complete! ${savedCount} saved, ${failedCount} failed`;
      showMessage(message, savedCount > 0 ? 'success' : 'error');
      
      if (savedCount > 0) {
        clearBulk();
      }
    });

    // Load puzzles
    async function loadPuzzles() {
      if (!isConnected) {
        showMessage('Not connected to Firebase', 'error');
        return;
      }
      
      try {
        console.log('📚 Loading puzzles...');
        
        const snapshot = await db.collection('puzzles')
          .orderBy('date', 'desc')
          .limit(50)
          .get();
        
        puzzles = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data && data.date) {
            puzzles.push(data);
          }
        });
        
        displayPuzzles(puzzles);
        console.log(`✅ Loaded ${puzzles.length} puzzles`);
        
      } catch (error) {
        console.error('❌ Error loading puzzles:', error);
        showMessage('Error loading puzzles: ' + error.message, 'error');
      }
    }

    function displayPuzzles(puzzleList) {
      const container = document.getElementById('puzzleList');
      
      if (puzzleList.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">No puzzles found.</p>';
        return;
      }
      
      container.innerHTML = puzzleList.map(p => `
        <div class="puzzle-item">
          <div class="puzzle-info">
            <div class="puzzle-date">${p.date}</div>
            <div class="puzzle-categories">${p.categories}</div>
            <div class="puzzle-answer">Answer: ${p.answer}</div>
            ${p.hint ? `<div class="help-text">Hint: ${p.hint}</div>` : '<div class="help-text">No hint</div>'}
          </div>
          <div class="puzzle-actions">
            <button class="btn btn-secondary" onclick="editPuzzle('${p.date}')">Edit</button>
            <button class="btn btn-danger" onclick="deletePuzzle('${p.date}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Edit puzzle
    function editPuzzle(date) {
      const puzzle = puzzles.find(p => p.date === date);
      if (!puzzle) return;
      
      // Switch to single puzzle tab
      showTab('single');
      
      // Parse categories
      const categories = puzzle.categories.split(' + ');
      
      // Fill form
      document.getElementById('date').value = puzzle.date;
      document.getElementById('category1').value = categories[0] || '';
      document.getElementById('category2').value = categories[1] || '';
      document.getElementById('answer').value = puzzle.answer;
      document.getElementById('hint').value = puzzle.hint || '';
      
      // Preview
      previewSingle();
      
      // Scroll to top
      window.scrollTo(0, 0);
    }

    // Delete puzzle
    async function deletePuzzle(date) {
      if (!confirm(`Delete puzzle for ${date}?`)) return;
      
      try {
        await db.collection('puzzles').doc(date).delete();
        showMessage(`✅ Deleted puzzle for ${date}`, 'success');
        
        // Remove from local array
        puzzles = puzzles.filter(p => p.date !== date);
        
        loadPuzzles(); // Refresh list
      } catch (error) {
        console.error('❌ Delete failed:', error);
        showMessage('Delete failed: ' + error.message, 'error');
      }
    }

    // Filter puzzles
    function filterPuzzles() {
      const startDate = document.getElementById('filterStartDate').value;
      const endDate = document.getElementById('filterEndDate').value;
      
      let filtered = puzzles;
      
      if (startDate) {
        filtered = filtered.filter(p => p.date >= startDate);
      }
      
      if (endDate) {
        filtered = filtered.filter(p => p.date <= endDate);
      }
      
      displayPuzzles(filtered);
    }

    // Export puzzles
    async function exportPuzzles() {
      if (!isConnected) {
        showMessage('Not connected to Firebase', 'error');
        return;
      }
      
      try {
        const snapshot = await db.collection('puzzles').get();
        const puzzles = [];
        snapshot.forEach(doc => puzzles.push(doc.data()));
        
        const dataStr = JSON.stringify(puzzles, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `punzzle-export-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        
        showMessage(`✅ Exported ${puzzles.length} puzzles`, 'success');
        
      } catch (error) {
        showMessage('Export failed: ' + error.message, 'error');
      }
    }

    // Load custom puzzles
    async function loadCustomPuzzles() {
      if (!isConnected) {
        showMessage('Not connected to Firebase', 'error');
        return;
      }
      
      try {
        console.log('📚 Loading custom puzzles...');
        
        const snapshot = await db.collection('customPuzzles')
          .orderBy('created', 'desc')
          .limit(100)
          .get();
        
        customPuzzles = [];
        snapshot.forEach(doc => {
          customPuzzles.push({ id: doc.id, ...doc.data() });
        });
        
        // Apply search and sort
        const searchTerm = document.getElementById('customSearchInput').value.toLowerCase();
        const sortBy = document.getElementById('customSortBy').value;
        
        let filtered = customPuzzles.filter(puzzle => {
          if (!searchTerm) return true;
          return puzzle.categories.toLowerCase().includes(searchTerm) ||
                 puzzle.answer.toLowerCase().includes(searchTerm);
        });
        
        // Sort puzzles
        filtered.sort((a, b) => {
          const statsA = analytics.customPuzzleStats[a.id] || {};
          const statsB = analytics.customPuzzleStats[b.id] || {};
          
          switch(sortBy) {
            case 'views':
              return (statsB.views || 0) - (statsA.views || 0);
            case 'plays':
              return (statsB.plays || 0) - (statsA.plays || 0);
            case 'shares':
              return (statsB.shares || 0) - (statsA.shares || 0);
            case 'completed':
              const compA = statsA.completed || 0;
              const compB = statsB.completed || 0;
              const playsA = statsA.plays || 1;
              const playsB = statsB.plays || 1;
              return (compB/playsB) - (compA/playsA);
            case 'playedAnother':
              return (statsB.playedAnother || 0) - (statsA.playedAnother || 0);
            default:
              return new Date(b.created) - new Date(a.created);
          }
        });
        
        // Update stats
        const totalViews = customPuzzles.reduce((sum, p) => {
          const stats = analytics.customPuzzleStats[p.id] || {};
          return sum + (stats.views || 0);
        }, 0);
        
        const totalShares = customPuzzles.reduce((sum, p) => {
          const stats = analytics.customPuzzleStats[p.id] || {};
          return sum + (stats.shares || 0);
        }, 0);
        
        const totalPlays = customPuzzles.reduce((sum, p) => {
          const stats = analytics.customPuzzleStats[p.id] || {};
          return sum + (stats.plays || 0);
        }, 0);
        
        const totalCompleted = customPuzzles.reduce((sum, p) => {
          const stats = analytics.customPuzzleStats[p.id] || {};
          return sum + (stats.completed || 0);
        }, 0);
        
        document.getElementById('totalCustomPuzzles').textContent = customPuzzles.length;
        document.getElementById('totalCustomViews').textContent = totalViews;
        document.getElementById('totalCustomShares').textContent = totalShares;
        document.getElementById('avgCustomCompletion').textContent = 
          totalPlays > 0 ? ((totalCompleted / totalPlays) * 100).toFixed(1) + '%' : '0%';
        
        displayCustomPuzzles(filtered);
        console.log(`✅ Loaded ${customPuzzles.length} custom puzzles`);
        
      } catch (error) {
        console.error('❌ Error loading custom puzzles:', error);
        showMessage('Error loading custom puzzles: ' + error.message, 'error');
      }
    }

    function displayCustomPuzzles(puzzleList) {
      const container = document.getElementById('customPuzzleList');
      
      if (puzzleList.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">No custom puzzles found.</p>';
        return;
      }
      
      container.innerHTML = puzzleList.map(p => {
        const stats = analytics.customPuzzleStats[p.id] || {};
        const views = stats.views || 0;
        const plays = stats.plays || 0;
        const completed = stats.completed || 0;
        const shares = stats.shares || 0;
        const playedAnother = stats.playedAnother || 0;
        const avgScore = stats.completed > 0 ? (stats.totalScore / stats.completed) : 0;
        const completionRate = plays > 0 ? ((completed / plays) * 100).toFixed(1) : 0;
        const playAnotherRate = plays > 0 ? ((playedAnother / plays) * 100).toFixed(1) : 0;
        
        // Generate the play URL
        const playUrl = `${window.location.origin}/?custom=${p.id}`;
        
        return `
          <div class="custom-puzzle-item">
            <button class="delete-custom-btn" onclick="deleteCustomPuzzle('${p.id}')">Delete</button>
            <div class="puzzle-info">
              <div class="puzzle-categories">${p.categories}</div>
              <div class="puzzle-answer">Answer: ${p.answer}</div>
              ${p.hint ? `<div class="help-text">Hint: ${p.hint}</div>` : '<div class="help-text">No hint</div>'}
              <div class="custom-stats">
                <span>Views: ${views}</span>
                <span>Plays: ${plays}</span>
                <span>Completed: ${completed}</span>
                <span>Shares: ${shares}</span>
                <span>Completion Rate: ${completionRate}%</span>
                <span>Played Another: ${playedAnother} (${playAnotherRate}%)</span>
                <span>Avg Score: ${avgScore.toFixed(1)}</span>
              </div>
              <div class="link-row">
                <span class="link-label">URL:</span>
                <input type="text" class="link-input" value="${playUrl}" readonly>
                <button class="copy-btn" onclick="copyToClipboard('${playUrl}')">Copy</button>
              </div>
              <div class="help-text">Created: ${new Date(p.created).toLocaleString()}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function deleteCustomPuzzle(puzzleId) {
      if (!confirm('Are you sure you want to delete this custom puzzle?')) return;
      
      try {
        await db.collection('customPuzzles').doc(puzzleId).delete();
        
        // Remove from local array
        customPuzzles = customPuzzles.filter(p => p.id !== puzzleId);
        delete analytics.customPuzzleStats[puzzleId];
        
        loadCustomPuzzles();
        showMessage('Custom puzzle deleted successfully', 'success');
      } catch (error) {
        console.error('Error deleting custom puzzle:', error);
        showMessage('Error deleting puzzle from database', 'error');
      }
    }

    // Copy to clipboard function
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showMessage('Copied to clipboard!', 'success');
      }).catch(err => {
        console.error('Failed to copy:', err);
        showMessage('Failed to copy to clipboard', 'error');
      });
    }

    // Bonus puzzle functions
    function previewBonus() {
      const category1 = document.getElementById('bonusCategory1').value || 'CATEGORY 1';
      const category2 = document.getElementById('bonusCategory2').value || 'CATEGORY 2';
      const answer = document.getElementById('bonusAnswer').value || 'ANSWER';
      const hint = document.getElementById('bonusHint').value;
      const title = document.getElementById('bonusTitle').value || 'TITLE';
      
      alert(`Preview:\n\nTitle: ${title}\nCategories: ${category1.toUpperCase()} + ${category2.toUpperCase()}\nAnswer: ${answer.toUpperCase()}\n${hint ? `Hint: ${hint}` : 'No hint'}`);
    }

    // Handle bonus puzzle submission
    document.getElementById('bonusPuzzleForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!isConnected) {
        showMessage('Not connected to Firebase. Please refresh the page.', 'error');
        return;
      }
      
      const category1 = document.getElementById('bonusCategory1').value.trim().toUpperCase();
      const category2 = document.getElementById('bonusCategory2').value.trim().toUpperCase();
      
      const puzzle = {
        title: document.getElementById('bonusTitle').value.trim(),
        categories: `${category1} + ${category2}`,
        answer: document.getElementById('bonusAnswer').value.trim().toUpperCase(),
        hint: document.getElementById('bonusHint').value.trim() || null,
        words: document.getElementById('bonusAnswer').value.trim().toUpperCase().split(' ').filter(w => w),
        expiry: document.getElementById('bonusExpiry').value || null,
        created: new Date().toISOString()
      };
      
      try {
        showMessage('Creating bonus puzzle...', 'success');
        
        const docRef = await db.collection('bonusPuzzles').add({
          ...puzzle,
          created: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        puzzle.id = docRef.id;
        
        // Generate URLs
        const baseUrl = window.location.origin + '/';
        puzzle.playUrl = `${baseUrl}?bonus=${docRef.id}`;
        puzzle.previewUrl = `${baseUrl}?bonus=${docRef.id}&preview=true`;
        
        // Update local storage
        bonusPuzzles.push(puzzle);
        
        showMessage('Bonus puzzle created successfully!', 'success');
        document.getElementById('bonusPuzzleForm').reset();
        loadBonusPuzzles();
        
      } catch (error) {
        console.error('Error creating bonus puzzle:', error);
        showMessage(`Error creating bonus puzzle: ${error.message}`, 'error');
      }
    });

    // Load bonus puzzles
    async function loadBonusPuzzles() {
      if (!isConnected) {
        return;
      }
      
      try {
        const snapshot = await db.collection('bonusPuzzles')
          .orderBy('created', 'desc')
          .get();
        
        bonusPuzzles = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          const baseUrl = window.location.origin + '/';
          bonusPuzzles.push({
            id: doc.id,
            ...data,
            playUrl: `${baseUrl}?bonus=${doc.id}`,
            previewUrl: `${baseUrl}?bonus=${doc.id}&preview=true`
          });
        });
        
        displayBonusPuzzles();
        
      } catch (error) {
        console.error('Error loading bonus puzzles:', error);
      }
    }

    function displayBonusPuzzles() {
      const container = document.getElementById('bonusPuzzleList');
      
      if (bonusPuzzles.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">No bonus puzzles created yet.</p>';
        return;
      }
      
      container.innerHTML = bonusPuzzles.map(p => {
        const isExpired = p.expiry && new Date(p.expiry) < new Date();
        const statusClass = isExpired ? 'status-expired' : 'status-active';
        const statusText = isExpired ? 'Expired' : 'Active';
        
        return `
          <div class="bonus-item">
            <div class="bonus-header">
              <div>
                <div class="bonus-title">${p.title}</div>
                <div class="puzzle-categories">${p.categories}</div>
                <div class="puzzle-answer">Answer: ${p.answer}</div>
                ${p.hint ? `<div class="help-text">Hint: ${p.hint}</div>` : '<div class="help-text">No hint</div>'}
              </div>
              <div>
                <span class="status-badge ${statusClass}">${statusText}</span>
              </div>
            </div>
            
            <div class="bonus-stats">
              <span>Created: ${new Date(p.created).toLocaleDateString()}</span>
              ${p.expiry ? `<span>Expires: ${new Date(p.expiry).toLocaleDateString()}</span>` : '<span>No expiry</span>'}
            </div>
            
            <div class="bonus-links">
              <div class="link-row">
                <span class="link-label">Play URL:</span>
                <input type="text" class="link-input" value="${p.playUrl}" readonly>
                <button class="copy-btn" onclick="copyToClipboard('${p.playUrl}')">Copy</button>
              </div>
              <div class="link-row">
                <span class="link-label">Preview URL:</span>
                <input type="text" class="link-input" value="${p.previewUrl}" readonly>
                <button class="copy-btn" onclick="copyToClipboard('${p.previewUrl}')">Copy</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Load analytics
    async function loadAnalytics() {
      if (!isConnected) {
        showMessage('Not connected to Firebase', 'error');
        return;
      }
      
      try {
        // Count puzzles
        const puzzleSnapshot = await db.collection('puzzles').get();
        document.getElementById('totalPuzzles').textContent = puzzleSnapshot.size;
        
        // Get game stats
        const statsSnapshot = await db.collection('gameStats').get();
        const gameStats = [];
        statsSnapshot.forEach(doc => {
          gameStats.push({ id: doc.id, ...doc.data() });
        });
        
        document.getElementById('totalPlays').textContent = gameStats.length;
        
        // Calculate completed puzzles and average score
        let completedCount = 0;
        let totalScore = 0;
        let scoreCount = 0;
        
        gameStats.forEach(stat => {
          const wasCompleted = stat.completed || stat.completedWithHints || (stat.score !== undefined && stat.score !== null);
          if (wasCompleted) {
            completedCount++;
            if (stat.score !== undefined && stat.score !== null) {
              totalScore += stat.score;
              scoreCount++;
            }
          }
        });
        
        document.getElementById('completedPuzzles').textContent = completedCount;
        const avgScore = scoreCount > 0 ? (totalScore / scoreCount).toFixed(1) : 0;
        document.getElementById('avgScore').textContent = avgScore;
        
        // Load link clicks
        const linksSnapshot = await db.collection('linkClicks').get();
        const linkClicks = {};
        
        linksSnapshot.forEach(doc => {
          const data = doc.data();
          const linkText = data.linkText || 'Unknown';
          
          if (!linkClicks[linkText]) {
            linkClicks[linkText] = { today: 0, week: 0, total: 0 };
          }
          
          const clickDate = data.timestamp?.toDate ? data.timestamp.toDate() : new Date(data.timestamp);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const weekAgo = new Date();
          weekAgo.setDate(weekAgo.getDate() - 7);
          
          linkClicks[linkText].total++;
          
          if (clickDate >= today) {
            linkClicks[linkText].today++;
          }
          
          if (clickDate >= weekAgo) {
            linkClicks[linkText].week++;
          }
        });
        
        // Update link tracking table
        const linkTable = document.getElementById('linkTrackingTable');
        const linkData = Object.entries(linkClicks)
          .filter(([link, data]) => data.total > 0)
          .sort((a, b) => b[1].total - a[1].total);
        
        if (linkData.length === 0) {
          linkTable.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">No link click data found</td></tr>';
        } else {
          linkTable.innerHTML = linkData.map(([link, data]) => `
            <tr>
              <td>${link}</td>
              <td>${data.today || 0}</td>
              <td>${data.week || 0}</td>
              <td>${data.total || 0}</td>
            </tr>
          `).join('');
        }
        
        // Update puzzle performance table
        const puzzleStats = {};
        gameStats.forEach(stat => {
          const puzzleDate = stat.date;
          if (puzzleDate && !stat.puzzleId?.startsWith('custom-')) {
            if (!puzzleStats[puzzleDate]) {
              puzzleStats[puzzleDate] = {
                plays: 0,
                completed: 0,
                totalScore: 0,
                scoreCount: 0
              };
            }
            
            puzzleStats[puzzleDate].plays++;
            const wasCompleted = stat.completed || stat.completedWithHints || (stat.score !== undefined && stat.score !== null);
            if (wasCompleted) {
              puzzleStats[puzzleDate].completed++;
              if (stat.score !== undefined && stat.score !== null) {
                puzzleStats[puzzleDate].totalScore += stat.score;
                puzzleStats[puzzleDate].scoreCount++;
              }
            }
          }
        });
        
        const perfTable = document.getElementById('puzzlePerformanceTable');
        const puzzleStatsEntries = Object.entries(puzzleStats)
          .sort((a, b) => b[0].localeCompare(a[0]))
          .slice(0, 20);
        
        if (puzzleStatsEntries.length === 0) {
          perfTable.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No puzzle performance data found</td></tr>';
        } else {
          perfTable.innerHTML = puzzleStatsEntries.map(([date, stats]) => {
            const puzzle = puzzles.find(p => p.date === date);
            const completionRate = stats.plays > 0 ? (stats.completed / stats.plays) : 0;
            const avgScore = stats.scoreCount > 0 ? (stats.totalScore / stats.scoreCount) : 0;
            
            return `
              <tr>
                <td>${date}</td>
                <td>${puzzle?.categories || 'N/A'}</td>
                <td>${stats.plays || 0}</td>
                <td>${avgScore.toFixed(1)}</td>
                <td>${(completionRate * 100).toFixed(1)}%</td>
              </tr>
            `;
          }).join('');
        }
        
        showMessage('✅ Analytics updated', 'success');
        
      } catch (error) {
        console.error('❌ Analytics load failed:', error);
        showMessage('Analytics load failed: ' + error.message, 'error');
      }
    }

    // Test connection
    async function testConnection() {
      try {
        console.log('🧪 Testing database connection...');
        
        // Test read
        const testRead = await db.collection('puzzles').limit(1).get();
        console.log('✅ Database read works');
        
        // Test write
        const testDoc = db.collection('test').doc('connection-test');
        await testDoc.set({
          test: true,
          timestamp: new Date(),
          message: 'Connection test from admin panel'
        });
        console.log('✅ Database write works');
        
        // Clean up
        await testDoc.delete();
        console.log('✅ Database fully operational!');
        
        showMessage('🎉 Database connection working perfectly!', 'success');
        updateConnectionStatus(true);
        
      } catch (error) {
        console.error('❌ Database test failed:', error);
        
        if (error.code === 'permission-denied') {
          showMessage('❌ Firebase permission denied - check security rules', 'error');
        } else {
          showMessage('❌ Database connection failed: ' + error.message, 'error');
        }
        
        updateConnectionStatus(false, error.message);
      }
    }

    // Load data function
    async function loadData() {
      try {
        // Load custom puzzle stats for analytics
        const statsSnapshot = await db.collection('customPuzzleStats').get();
        statsSnapshot.forEach(doc => {
          analytics.customPuzzleStats[doc.id] = doc.data();
        });
        
        console.log('✅ Data loaded successfully');
        
      } catch (error) {
        console.error('❌ Error loading data:', error);
      }
    }

    // Settings functions
    function exportAllData() {
      const data = {
        puzzles: puzzles,
        customPuzzles: customPuzzles,
        bonusPuzzles: bonusPuzzles,
        analytics: analytics,
        exportDate: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(data, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `punzzle-backup-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
      
      showMessage('✅ Data exported successfully', 'success');
    }

    function importData() {
      document.getElementById('importFile').click();
    }

    function handleImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          if (confirm('Import data? This will replace existing local data (Firebase data will remain unchanged).')) {
            puzzles = data.puzzles || [];
            customPuzzles = data.customPuzzles || [];
            bonusPuzzles = data.bonusPuzzles || [];
            analytics = data.analytics || analytics;
            
            showMessage('✅ Data imported successfully!', 'success');
          }
        } catch (error) {
          showMessage('❌ Error importing file: ' + error.message, 'error');
        }
      };
      reader.readAsText(file);
      
      // Clear the input
      event.target.value = '';
    }

    function clearAllData() {
      if (!confirm('Are you sure you want to clear all local data? (Firebase data will remain unchanged)')) return;
      
      puzzles = [];
      customPuzzles = [];
      bonusPuzzles = [];
      analytics = {
        totalPlays: 0,
        completedPuzzles: 0,
        incompletePuzzles: 0,
        avgScore: 0,
        shareRate: 0,
        linkClicks: {},
        puzzleStats: {},
        customPuzzleStats: {}
      };
      
      showMessage('✅ Local data cleared', 'success');
    }

    // Real-time preview for single puzzle
    ['category1', 'category2', 'answer', 'hint', 'date'].forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('input', previewSingle);
      }
    });

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Set today's date
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date').value = today;
      document.getElementById('bulkStartDate').value = today;
    });

    // Make functions globally available
    window.showTab = showTab;
    window.setQuickDate = setQuickDate;
    window.previewSingle = previewSingle;
    window.clearForm = clearForm;
    window.showTemplate = showTemplate;
    window.downloadTemplate = downloadTemplate;
    window.previewBulk = previewBulk;
    window.clearBulk = clearBulk;
    window.loadPuzzles = loadPuzzles;
    window.editPuzzle = editPuzzle;
    window.deletePuzzle = deletePuzzle;
    window.filterPuzzles = filterPuzzles;
    window.exportPuzzles = exportPuzzles;
    window.loadCustomPuzzles = loadCustomPuzzles;
    window.deleteCustomPuzzle = deleteCustomPuzzle;
    window.copyToClipboard = copyToClipboard;
    window.previewBonus = previewBonus;
    window.loadBonusPuzzles = loadBonusPuzzles;
    window.loadAnalytics = loadAnalytics;
    window.testConnection = testConnection;
    window.exportAllData = exportAllData;
    window.importData = importData;
    window.handleImport = handleImport;
    window.clearAllData = clearAllData;
    window.logout = logout;
  </script>
</body>
</html>